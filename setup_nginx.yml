- name: NGINX | Adding NGINX signing key
  apt_key: url=http://nginx.org/keys/nginx_signing.key state=present

- name: NGINX | Adding sources.list deb url for NGINX
  lineinfile: dest=/etc/apt/sources.list line="deb http://nginx.org/packages/mainline/ubuntu/ {{ ansible_distribution_release }} nginx"

- name: NGINX | Updating apt cache
  apt:
    update_cache: yes

- name: NGINX | Installing NGINX
  apt:
    pkg:
    - nginx
    state: latest

- name: NGINX | Starting NGINX
  service:
    name: nginx
    state: started

- name: NGINX | Getting NGINX User conf
  shell: |
    cat /etc/nginx/nginx.conf | grep -E '\buser\b' | sed 's/user//g;s/\;//g' | tr -d ' ' > /tmp/nginxuser.txt

- name: NGINX | Configuring NGINX
  copy:
    dest: "/etc/nginx/nginx.conf"
    owner: root
    group: root
    mode: 0644
    force: yes
    content: |
      user  NGINX_USER;
      worker_processes  auto;

      error_log  /var/log/nginx/error.log warn;
      pid        /var/run/nginx.pid;


      events {
          worker_connections  1024;
      }


      http {
          include       /etc/nginx/mime.types;
          default_type  application/octet-stream;

          limit_conn_zone $binary_remote_addr zone=addr:10m;
          server_names_hash_bucket_size  256;

          client_max_body_size 10m;

          log_format log_standard '$remote_addr, $http_x_forwarded_for - $remote_user [$time_local] "$request_method $scheme://$host$request_uri $server_protocol" $status $body_bytes_sent "$http_referer" "$http_user_agent" to: $upstream_addr';

          access_log /var/log/nginx/access.log log_standard;
          error_log /var/log/nginx/error.log;

          sendfile        on;
          #tcp_nopush     on;

          keepalive_timeout  65;

          #gzip  on;

          include /etc/nginx/conf.d/*.conf;
      }

- name: NGINX | Adjusting NGINX User conf
  shell: |
    nginx_user=$(cat /tmp/nginxuser.txt | tr -d '\n')
    echo "Nginx User: $nginx_user"
    sed -i "s/NGINX_USER/$nginx_user/g" /etc/nginx/nginx.conf

- name: NGINX | Removing default NGINX configs
  shell: |
    rm -rf /etc/nginx/conf.d/*

- name: NGINX | Default http
  copy:
    dest: "/etc/nginx/conf.d/default.conf"
    owner: root
    group: root
    mode: 0644
    force: yes
    content: |
      server {
          listen 80 ;
          server_name _;

          location / {
             return 403;
          }

          error_page 403 /403.txt;
          location /403.txt{
              internal;
              return 403 'Forbidden';
          }
      }

- name: NGINX | Restarting Nginx
  service:
    name: nginx
    state: restarted

- name: Docker | /tmp/v3.ext
  copy:
    dest: "/tmp/v3.ext"
    content: |
      authorityKeyIdentifier=keyid,issuer
      basicConstraints=CA:FALSE
      keyUsage=digitalSignature,keyEncipherment
      extendedKeyUsage=serverAuth
      subjectAltName=DNS:*.labs.sec4us.com.br,DNS:labs.sec4us.com.br,DNS:registry.labs.sec4us.com.br


- name: NGINX | Create a self signed certificate
  shell: |
    cd /tmp/
    mkdir -p /etc/nginx/certs/

    openssl genrsa -out /etc/nginx/certs/root-ca-key.pem 4096
       
    openssl req -new -x509 -sha256 -key /etc/nginx/certs/root-ca-key.pem -subj "/C=BR/ST=PR/L=Curitiba/O=Security/OU=Treinamentos/CN=Sec4US Root CA" -out /etc/nginx/certs/root-ca.pem -days 3650
    
    openssl genrsa -out /tmp/tls-key-temp.pem 4096
    openssl pkcs8 -inform PEM -outform PEM -in /tmp/tls-key-temp.pem -topk8 -nocrypt -v1 PBE-SHA1-3DES -out /etc/nginx/certs/ssl.key
       
    openssl req -new -key /etc/nginx/certs/ssl.key -subj "/C=BR/ST=PR/L=Curitiba/O=Security/OU=DevSecOps/CN=labs.sec4us.com.br" -out /tmp/admin.csr
       
    openssl x509 -req -in /tmp/admin.csr -CA /etc/nginx/certs/root-ca.pem -CAkey /etc/nginx/certs/root-ca-key.pem -CAcreateserial -sha256 -out /etc/nginx/certs/ssl.cer -days 730 -extfile /tmp/v3.ext


- name: NGINX | Save root CA to local machine
  shell: |
    rsync -av /etc/nginx/certs/root-ca.pem /usr/local/share/ca-certificates/root-ca.crt
    update-ca-certificates
    mkdir -p /etc/docker/certs.d/registry.labs.sec4us.com.br
    rsync -av /etc/nginx/certs/root-ca.pem /etc/docker/certs.d/registry.labs.sec4us.com.br/ca.crt

