---
- name: "List existing users"
  uri:
    url: "{{ gitlab_external_url }}/api/{{ gitlab_api_version }}/users"
    method: "GET"
    headers:
      PRIVATE-TOKEN: "{{ gitlab_admin_token }}"
    validate_certs: false
    return_content: true
  register: user_list_output

- name: "Check if user is already exists"
  set_fact:
    user_exists: "{{ gitlab_username in (user_list_output.json |\
      map(attribute='username') | list) }}"

- name: "Create user"
  uri:
    url: "{{ gitlab_external_url }}/api/{{ gitlab_api_version }}/users"
    method: "POST"
    headers:
      PRIVATE-TOKEN: "{{ gitlab_admin_token }}"
    body: "name={{ gitlab_name }}&username={{ gitlab_username }}&\
      email={{ gitlab_master_email }}&password={{ gitlab_password }}&\
      skip_confirmation=true"
    body_format: raw
    validate_certs: false
    return_content: true
    status_code: 201
  register: user_output
  when: not user_exists

- name: "Set user ID"
  set_fact:
    gitlab_user_id: "{{ user_output.json.id }}"
  when: not user_exists

- name: "Get user ID"
  set_fact:
    gitlab_user_id: "{{ item.id }}"
  loop: "{{ user_list_output.json }}"
  when:
    - user_exists
    - item.username == gitlab_username

- name: "User debug"
  debug:
    msg: "User id is {{ gitlab_user_id }}"

- name: "List existing users in group"
  uri:
    url: "{{ gitlab_external_url }}/api/{{ gitlab_api_version }}/groups/\
      {{ gitlab_project_group_id }}/members"
    method: "GET"
    headers:
      PRIVATE-TOKEN: "{{ gitlab_admin_token }}"
    validate_certs: false
    return_content: true
  register: member_list_output

- name: "Check if user is already exists in group"
  set_fact:
    member_exists: "{{ gitlab_username in (member_list_output.json |\
      map(attribute='username') | list) }}"

- name: "Add user to group"
  uri:
    url: "{{ gitlab_external_url }}/api/{{ gitlab_api_version }}/groups/\
      {{ gitlab_project_group_id }}/members"
    method: "POST"
    headers:
      PRIVATE-TOKEN: "{{ gitlab_admin_token }}"
    body: "user_id={{ gitlab_user_id }}&access_level=40" # access_level=40 -> Maintainer
    body_format: raw
    validate_certs: false
    return_content: true
    status_code: 201
  when: not member_exists
